<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>Speakeasy</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overscroll-behavior-y: contain; }
        .pulse-ring { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark #chat-container::-webkit-scrollbar-thumb { background-color: #4b5563; }
    </style>
</head>
<body class="flex flex-col h-screen max-h-screen overflow-hidden bg-gray-100 dark:bg-gray-900 transition-colors duration-200">

    <!-- Top Bar -->
    <div class="bg-white dark:bg-gray-800 shadow-sm p-4 z-10 flex justify-between items-center shrink-0 transition-colors duration-200 safe-top">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-gray-800 dark:text-white">Speakeasy</h1>
            <button id="swap-lang-btn" class="flex items-center gap-2 px-3 py-1 bg-indigo-50 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded-full text-xs font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900 transition-colors">
                <span id="lang-label-source">EN</span>
                <i class="fas fa-arrow-right text-gray-400"></i>
                <span id="lang-label-target">VN</span>
                <i class="fas fa-sync-alt ml-1 opacity-50"></i>
            </button>
        </div>
        
        <div class="flex items-center gap-2">
            <a href="http://paypal.me/sivarajpragasm" target="_blank" class="px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full text-xs font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">Donate</a>
            <button id="theme-toggle" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:inline"></i>
            </button>
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 relative">
        <div class="flex justify-center opacity-50 pt-10" id="welcome-msg">
            <p class="text-sm text-gray-400 dark:text-gray-500">Tap microphone to speak</p>
        </div>
        <div id="live-preview" class="hidden mx-auto bg-black/75 text-white px-4 py-2 rounded-lg text-center text-sm absolute bottom-4 left-4 right-4 backdrop-blur-sm z-20">...</div>
    </div>

    <!-- Bottom Controls -->
    <div class="bg-white dark:bg-gray-800 p-6 border-t border-gray-200 dark:border-gray-700 shrink-0 flex flex-col items-center transition-colors duration-200 safe-bottom">
        <div id="status-text" class="text-gray-500 dark:text-gray-400 text-sm mb-3 font-medium h-5"></div>
        <button id="mic-btn" class="w-20 h-20 rounded-full bg-indigo-600 text-white text-3xl flex items-center justify-center shadow-xl hover:bg-indigo-700 transition-all active:scale-95">
            <i class="fas fa-microphone"></i>
        </button>
        <p class="text-gray-400 dark:text-gray-500 text-xs mt-3">Hold to speak • Release to show</p>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
        }

        const LANG_CONFIG = {
            'en': { code: 'en-US', name: 'EN', translateCode: 'en', voiceCode: 'en-US' },
            'vi': { code: 'vi-VN', name: 'VN', translateCode: 'vi', voiceCode: 'vi-VN' }
        };

        const QUESTION_STARTERS_EN = ['who', 'what', 'where', 'when', 'why', 'how', 'do', 'does', 'did', 'is', 'are', 'was', 'were', 'can', 'could', 'would', 'will', 'should', 'may'];
        const QUESTION_STARTERS_VN = ['ai', 'cái gì', 'ở đâu', 'khi nào', 'tại sao', 'làm sao', 'như thế nào', 'có phải', 'vì sao'];

        // --- INTERNAL DICTIONARY (INSTANT MODE) ---
        const LOCAL_PHRASEBOOK = {
            'en': {
                'hello': 'Xin chào',
                'how are you': 'Bạn khỏe không',
                'im fine': 'Tôi khỏe',
                'i am fine': 'Tôi khỏe',
                'thank you': 'Cảm ơn',
                'thanks': 'Cảm ơn',
                'bye': 'Tạm biệt',
                'goodbye': 'Tạm biệt',
                'good morning': 'Chào buổi sáng',
                'good night': 'Chúc ngủ ngon'
            },
            'vi': {
                'xin chào': 'Hello',
                'bạn khỏe không': 'How are you',
                'cảm ơn': 'Thank you',
                'tạm biệt': 'Goodbye',
                'chào buổi sáng': 'Good morning',
                'chúc ngủ ngon': 'Good night'
            }
        };

        let currentSource = 'en', currentTarget = 'vi', isRecording = false;

        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        const chatContainer = document.getElementById('chat-container');
        const livePreview = document.getElementById('live-preview');
        const welcomeMsg = document.getElementById('welcome-msg');
        const swapBtn = document.getElementById('swap-lang-btn');
        const themeBtn = document.getElementById('theme-toggle');
        const labelSource = document.getElementById('lang-label-source');
        const labelTarget = document.getElementById('lang-label-target');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        function initRecognition() {
            if (SpeechRecognition) {
                if (recognition) recognition.abort();
                recognition = new SpeechRecognition();
                recognition.lang = LANG_CONFIG[currentSource].code;
                recognition.interimResults = true; 
                recognition.maxAlternatives = 1;
                setupRecognitionEvents();
            } else {
                alert("Browser not supported. Please use Chrome.");
            }
        }
        initRecognition();

        micBtn.addEventListener('mousedown', startRecording);
        micBtn.addEventListener('mouseup', stopRecording);
        micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        micBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
        swapBtn.addEventListener('click', swapLanguages);
        themeBtn.addEventListener('click', toggleTheme);

        function swapLanguages() {
            const temp = currentSource;
            currentSource = currentTarget;
            currentTarget = temp;
            labelSource.textContent = LANG_CONFIG[currentSource].name;
            labelTarget.textContent = LANG_CONFIG[currentTarget].name;
            initRecognition();
            statusText.textContent = `Switched: Speak ${LANG_CONFIG[currentSource].name}`;
            setTimeout(() => { if(!isRecording) statusText.textContent = "Ready"; }, 2000);
        }

        function toggleTheme() { document.documentElement.classList.toggle('dark'); }

        function startRecording() {
            if (!recognition || isRecording) return;
            try { recognition.start(); isRecording = true; updateUIState('listening'); if(welcomeMsg) welcomeMsg.style.display = 'none'; } catch (e) { console.error(e); }
        }

        function stopRecording() {
            if (!recognition || !isRecording) return;
            try { recognition.stop(); isRecording = false; } catch (e) { console.error(e); }
        }

        function formatSentence(text, lang) {
            if (!text) return text;
            text = text.trim();
            text = text.charAt(0).toUpperCase() + text.slice(1);
            if (['.', '?', '!', ',', ';'].includes(text.charAt(text.length - 1))) return text;
            
            const firstWord = text.split(' ')[0].toLowerCase();
            const starters = lang === 'en' ? QUESTION_STARTERS_EN : QUESTION_STARTERS_VN;
            const lastWord = text.split(' ').pop().toLowerCase();
            const vnEndings = ['không', 'chưa', 'nhỉ', 'hả'];
            
            let isQuestion = starters.includes(firstWord);
            if (lang === 'vi' && vnEndings.includes(lastWord)) isQuestion = true;
            return text + (isQuestion ? '?' : '.');
        }

        function checkLocalDictionary(text, sourceLang) {
            const key = text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim();
            if (LOCAL_PHRASEBOOK[sourceLang] && LOCAL_PHRASEBOOK[sourceLang][key]) {
                return LOCAL_PHRASEBOOK[sourceLang][key];
            }
            return null;
        }

        // --- NORMALIZATION FUNCTION ---
        function normalizeInput(text) {
            const clean = text.toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            if (clean === 'hi') return 'Hello';
            return text;
        }

        function setupRecognitionEvents() {
            recognition.onresult = async (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    else interimTranscript += event.results[i][0].transcript;
                }

                if (interimTranscript) {
                    livePreview.textContent = interimTranscript;
                    livePreview.classList.remove('hidden');
                } else {
                    livePreview.classList.add('hidden');
                }

                if (finalTranscript) {
                    updateUIState('processing');
                    
                    // 1. Normalize Input (Hi -> Hello)
                    const normalizedText = normalizeInput(finalTranscript);
                    
                    // 2. Format Input
                    const formattedInput = formatSentence(normalizedText, currentSource);
                    addMessage('user', formattedInput);
                    
                    let translatedText = checkLocalDictionary(normalizedText, currentSource);
                    
                    if (!translatedText) {
                        translatedText = await translateText(normalizedText);
                    }

                    if (translatedText) {
                        const formattedOutput = formatSentence(translatedText, currentTarget);
                        addMessage('bot', formattedOutput);
                        speakText(formattedOutput);
                    }
                    updateUIState('idle');
                }
            };
            recognition.onerror = () => { statusText.textContent = "Error: Try closer to mic"; updateUIState('idle'); };
            recognition.onend = () => { if(isRecording) { isRecording = false; updateUIState('idle'); } };
        }

        async function translateText(text) {
            statusText.textContent = "Translating...";
            const pair = `${LANG_CONFIG[currentSource].translateCode}|${LANG_CONFIG[currentTarget].translateCode}`;
            const randomID = Math.floor(Math.random() * 1000000);
            const email = 'speakeasy_user_' + randomID + '@gmail.com'; 
            
            try {
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${pair}&de=${email}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.responseData.translatedText.includes("ETS TEST")) {
                    return "Server busy (Try again in 1 min)";
                }
                return data.responseData.translatedText;
            } catch (error) { return "Connection Error"; }
        }

        function speakText(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = LANG_CONFIG[currentTarget].voiceCode;
            const voices = window.speechSynthesis.getVoices();
            const targetCode = LANG_CONFIG[currentTarget].translateCode;
            const voice = voices.find(v => v.lang.includes(targetCode));
            if (voice) utterance.voice = voice;
            window.speechSynthesis.speak(utterance);
        }

        function copyToClipboard(text, btnElement) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalIcon = btnElement.innerHTML;
                btnElement.innerHTML = '<i class="fas fa-check"></i>';
                btnElement.classList.add('text-green-500');
                setTimeout(() => { btnElement.innerHTML = originalIcon; btnElement.classList.remove('text-green-500'); }, 1500);
            } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
        }

        function updateUIState(state) {
            if (state === 'listening') {
                micBtn.className = "w-24 h-24 rounded-full bg-red-500 text-white text-4xl flex items-center justify-center shadow-xl pulse-ring";
                micBtn.innerHTML = '<i class="fas fa-waveform"></i>';
                statusText.textContent = `Listening (${LANG_CONFIG[currentSource].name})...`;
                statusText.className = "text-red-500 text-lg font-bold mb-3 h-5";
            } else if (state === 'processing') {
                livePreview.classList.add('hidden');
                micBtn.className = "w-20 h-20 rounded-full bg-indigo-300 dark:bg-indigo-700 text-white text-3xl flex items-center justify-center shadow-none";
                micBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                statusText.textContent = "Translating...";
                statusText.className = "text-indigo-500 dark:text-indigo-400 text-sm font-medium mb-3 h-5";
            } else {
                micBtn.className = "w-20 h-20 rounded-full bg-indigo-600 text-white text-3xl flex items-center justify-center shadow-xl hover:bg-indigo-700 transition-all";
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                statusText.textContent = "Ready";
                statusText.className = "text-gray-400 dark:text-gray-500 text-sm mb-3 h-5";
            }
        }

        function addMessage(sender, text) {
            const div = document.createElement('div');
            div.className = 'flex flex-col w-full ' + (sender === 'user' ? 'items-end mb-2' : 'items-start mb-8');
            const bubbleGroup = document.createElement('div');
            bubbleGroup.className = 'flex items-center gap-2 max-w-full ' + (sender === 'user' ? 'flex-row-reverse' : 'flex-row');
            const bubble = document.createElement('div');
            if (sender === 'user') {
                bubble.className = 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-sm px-4 py-2 rounded-2xl rounded-tr-none max-w-[80%]';
            } else {
                const sizeClass = text.length > 50 ? 'text-2xl' : 'text-4xl';
                bubble.className = `bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-500 text-indigo-900 dark:text-indigo-100 ${sizeClass} font-bold p-6 rounded-r-2xl w-full shadow-md leading-tight`;
            }
            bubble.textContent = text;
            if (sender === 'bot') {
                const copyBtn = document.createElement('button');
                copyBtn.className = "w-8 h-8 rounded-full bg-white dark:bg-gray-700 text-gray-400 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-300 shadow-sm flex items-center justify-center transition-colors";
                copyBtn.innerHTML = '<i class="far fa-copy"></i>';
                copyBtn.onclick = () => copyToClipboard(text, copyBtn);
                bubbleGroup.appendChild(bubble);
                bubbleGroup.appendChild(copyBtn);
            } else { bubbleGroup.appendChild(bubble); }
            div.appendChild(bubbleGroup);
            const label = document.createElement('span');
            label.className = 'text-xs text-gray-300 dark:text-gray-600 mt-1 px-1';
            const langName = sender === 'user' ? LANG_CONFIG[currentSource].name : LANG_CONFIG[currentTarget].name;
            label.textContent = sender === 'user' ? `You (${langName}):` : `Translation (${langName}):`;
            div.appendChild(label);
            chatContainer.appendChild(div);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
        window.speechSynthesis.getVoices();
    </script>
</body>
</html>
